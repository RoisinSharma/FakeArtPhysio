<!DOCTYPE HTML>
<html>
    <head>
        <!--create title shown in tab; not the same as header on webpage-->
        <title>Experiment</title>

        <!--Load JsPsych -->
        <script src="https://unpkg.com/jspsych@8.2.2"></script>
        <link
            href="https://unpkg.com/jspsych@8.2.2/css/jspsych.css"
            rel="stylesheet"
            type="text/css"
        />

        <!--Load all necessary plugins stored in utils-->
        <script src="https://unpkg.com/@jspsych/plugin-survey@3.0.0"></script>
        <link
            rel="stylesheet"
            href="https://unpkg.com/@jspsych/plugin-survey@3.0.0/css/survey.css"
        />
        <script src="https://unpkg.com/@jspsych/plugin-html-keyboard-response@2.1.0"></script>
        <script src="https://unpkg.com/@jspsych/plugin-html-button-response@2.1.0"></script>
        <script src="https://unpkg.com/@jspsych/plugin-fullscreen@2.0.0"></script>
        <script src="https://unpkg.com/@jspsych/plugin-audio-button-response@2.1.0"></script>
        <script src="https://unpkg.com/@jspsych/plugin-audio-keyboard-response@2.1.0"></script>
        <script src="utils/jspsych/plugin-canvas-button-response.js"></script>
        <script src="https://unpkg.com/@jspsych/plugin-preload@2.1.0"></script>
        <script src="https://unpkg.com/@jspsych/plugin-canvas-keyboard-response@2.1.0"></script>

        <!-- Load task specific code -->
        <script src="demographics.js"></script>
        <script src="parameters.js"></script>
        <script src="HCT.js"></script>
        <script src="questionnaires.js"></script>
        <script src="TAP.js"></script>
    </head>

    <body></body>

    <script>

        var participant_ID = {
            type: jsPsychSurvey,
            survey_json: {
                title: "About yourself",
                completeText: "Continue",
                pageNextText: "Next",
                pagePrevText: "Previous",
                goNextPageAutomatic: false,
                showQuestionNumbers: false,
                on_start: function () {
                    jsPsych.progressBar.progress = 0.0
                },
                pages: [
                    {
                        elements: [
                            {
                                title: "Enter the participant's ID:",
                                type: "text",
                                placeholder: "000",
                                name: "Participant_ID",
                                isRequired: true,
                            },
                        ],
                    },
                ],
            },
            data: {
                screen: "ppt_id",
            },
        }

        // Initialize experiment ===============================================================
        var jsPsych = initJsPsych({
             show_progress_bar: true,
             message_progress_bar: "Progress",
             auto_update_progress_bar: false,
            on_finish: function () {
                // Get participant ID
                // jsPsych.data.displayData("json")
                let participantID = jsPsych.data
                    .get()
                    .filter({ screen: "ppt_id" })
                    .values()[0].response["Participant_ID"]

                // Save as JSON file locally
                jsPsych.data
                    .get()
                    .localSave("json", `${participantID}_int.json`)
            },
        })

        // Initialize timeline
        var timeline = []

        // Demographics
        timeline.push(participant_ID)

        // Enter fullscreen mode
        timeline.push({
            type: jsPsychFullscreen,
            fullscreen_mode: true,
            delay_after: 0,
            data: {
                screen: "fullscreen_start",
            },
        })

        // Questionnaires ================================
        const questionnaire_block = {
            timeline: [
                questionnaires_instructions,
                jsPsych.randomization.shuffleNoRepeats([
                    questionnaire_maia,
                    questionnaire_mint,
                    questionnaire_ias,
                    questionnaire_phq4,
                    questionnaire_erns,
                ]),
            ],
        } // randomise order of questionnaires


        // TAP procedure ===========================
        // Voluntary External Tapping
        timeline.push(VoluntaryExternal_instructions)
        timeline.push(TAP_countdown)
        timeline.push(makeTAPblock(1, "external")) //change number back to 40 for testing

        // Voluntary Internal Tapping
        timeline.push(VoluntaryInternal_instructions)
        timeline.push(TAP_countdown)
        timeline.push(makeTAPblock(1, "internal")) //change number back to 40 for testing

        // Mixed Trials
        timeline.push(Mixedtrials_instructions)
        timeline.push(TAP_countdown)
        timeline.push(makeTAPblock(1, "mixed")) //change number back to 80 for testing

        // Rhythmic Tapping
        timeline.push(TAP_preload)
        timeline.push(RhytmicTapping_instructions)
        timeline.push(TAP_countdown)
        timeline.push(TAP_beep_sequence) // Synchrony phase
        timeline.push(create_TAP_sequence("Tap_Synchrony", 1)) //change number back to 120 for testing

        // Random Tapping
        timeline.push(RhytmicRandom_instructions)
        timeline.push(TAP_countdown)
        timeline.push(create_TAP_sequence("TAP_random", 1)) //change number back to 120 for testing

        // Heart Tapping
        timeline.push(HeartTapping_Instructions)
        timeline.push(create_TAP_sequence("TAP_heart", 1)) //change number back to 120 for testing


        //HCT ===============================

        const HCT_procedure = {
            timeline: [
                HCT_instructions,
                {
                    timeline: [
                        HCT_countdown,
                        HCT_interval(),
                        HCT_beep,
                        HCT_items,
                    ],
                    timeline_variables: HCT_durations.map((i) => ({
                        duration: i * 1000,
                    })),
                    randomize_order: true,
                },
            ],
        }

        // Counterbalance HTC and Questionnaires

        count_tasks = jsPsych.randomization.shuffleNoRepeats([
            questionnaire_block,
            HCT_procedure,
        ])

        timeline.push(count_tasks)

        timeline.push({
            type: jsPsychHtmlButtonResponse,
            stimulus: "You've reached the end of this part!",
            choices: ["Exit Fullscreen"],
            on_finish: function () {
                document.exitFullscreen()
            },
        })



        // Run the timeline -------------------------------------------------------
        jsPsych.run(timeline)

        // Run: first sync then start experiment =================================================================
        syncLSL()
            .then(function () {
                startExperiment()
            })
            .catch(function (err) {
                console.warn("Proceeding without LSL sync (sync failed):", err)
                startExperiment()
            })
    </script>
</html>
